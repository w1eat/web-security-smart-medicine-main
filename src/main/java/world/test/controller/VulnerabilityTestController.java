package world.test.controller;

import com.baomidou.mybatisplus.core.conditions.update.UpdateWrapper;
import org.springframework.web.bind.annotation.*;
import world.test.dao.UserDao;
import world.test.entity.User;
import world.test.service.UserService;

import javax.annotation.Resource;

/**
 * 漏洞测试控制器 - 用于演示CVE-2024-35548
 * 注意：仅用于安全测试目的
 */
@RestController
@RequestMapping("/vuln-test")
public class VulnerabilityTestController {

    @Resource
    private UserDao userDao;

    @Resource
    private UserService userService;

    /**
     * 测试UpdateWrapper SQL注入漏洞 - CVE-2024-35548
     * 正常情况下应该使用LambdaUpdateWrapper，但这里故意使用有问题的方式
     */
    @PostMapping("/update-user")
    public String updateUserVulnerable(@RequestParam String columnName, @RequestParam String value) {
        try {
            // 这种方式存在SQL注入风险
            UpdateWrapper<User> updateWrapper = new UpdateWrapper<>();
            // 漏洞点：直接使用用户输入作为列名
            updateWrapper.eq(columnName, value);
            
            User user = new User();
            user.setUserName("test");
            
            int result = userDao.update(user, updateWrapper);
            return "更新成功，影响行数：" + result;
        } catch (Exception e) {
            return "执行出错：" + e.getMessage();
        }
    }

    /**
     * 安全的更新方式（正确的做法）
     */
    @PostMapping("/update-user-safe")
    public String updateUserSafe(@RequestParam String userEmail, @RequestParam String newUserName) {
        try {
            // 使用LambdaUpdateWrapper或者明确指定列名的方式是安全的
            UpdateWrapper<User> updateWrapper = new UpdateWrapper<>();
            updateWrapper.eq("user_email", userEmail); // 明确指定列名
            
            User user = new User();
            user.setUserName(newUserName);
            
            int result = userDao.update(user, updateWrapper);
            return "更新成功，影响行数：" + result;
        } catch (Exception e) {
            return "执行出错：" + e.getMessage();
        }
    }
}